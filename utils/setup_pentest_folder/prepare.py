#!/bin/python3
# ./prepare.py -s settings.toml
import argparse
import logging
from argparse import ArgumentParser, Namespace
from pathlib import Path
import shutil
from typing import List, Self
import toml

BASE_PATH=Path.cwd()

class Host():
    def __init__(self, hostname, parent_path: Path, already_present: bool, files: List[str]):
        self.hostname = hostname
        self.parent_path = parent_path
        self.already_present = already_present
        self.files = files

    def __str__(self):
        return f"HOST [{self.hostname}] {'' if self.already_present else 'NEW'}"

    @staticmethod    
    def create_hosts_list_from_path(hosts_path: Path, host_files: List[str]) -> List[Self]:
        hl = []
        try:
            hid = hosts_path.iterdir()
            hl = list(hid)
        except FileNotFoundError as e:
            pass
        return [Host(host.name, host.parent, True, host_files) for host in hl]
    
    @staticmethod
    def create_hosts_list(given_hostnames: list, hosts_path: Path, host_files: List[str]) -> List[Self]:
        # Retrieve old hosts
        current_hosts: List[Host] = Host.create_hosts_list_from_path(hosts_path, host_files)
        # Create an all hosts list (current + given)
        hosts_all = []
        hosts_all.extend(current_hosts)
        # Add new hosts
        given_hostnames = list(dict.fromkeys(given_hostnames))  # Remove any duplicates from given list
        current_hostnames = [h.hostname for h in current_hosts]  # Get current hostnames
        for given_hostname in given_hostnames:
            if given_hostname not in current_hostnames:
                logging.debug(f"New host detected: {hosts_path.name} - {given_hostname}")
                hosts_all.append(Host(given_hostname, hosts_path, False, host_files))
            else:
                logging.debug(f"Already known host: {hosts_path.name} - {given_hostname}")
        sorted_hosts_all = sorted(hosts_all, key=lambda h: h.hostname)
        return sorted_hosts_all

    def create_tree(self, overwrite: bool):
        for file in self.files:
            file_path: Path = self.parent_path / self.hostname / file
            logging.debug(f"MKDIR PARENT {file_path.parent}")
            file_path.parent.mkdir(parents=True, exist_ok=True)
            create_file(file_path, overwrite)

class Network():
    def __init__(self, hosts_list: List[str], hosts_path: Path, host_files: List[str], name: str, overwrite: bool):
        self.hosts_list = hosts_list
        self.hosts_path = hosts_path
        self.name = name
        self.overwrite = overwrite
        self.hosts: List[Host] = Host.create_hosts_list(self.hosts_list, self.hosts_path, host_files)

    def __str__(self):
        return f"NET [{self.name}]"

    def create_tree(self):
        for host in self.hosts:
            host.create_tree(self.overwrite)

    def create_hosts_file(self):
        create_file(self.hosts_path, self.overwrite)
        hosts_file_path = self.hosts_path.parent / (self.hosts_path.name + '-hosts.txt')
        with hosts_file_path.open('a+') as f:
            f.seek(0)
            known_hosts = f.readlines()
            new_hosts = []
            for host in self.hosts:
                if host.hostname not in known_hosts and host.hostname not in new_hosts:
                    new_hosts.append(host)
                    f.write(f"{host.hostname}\r\n")

class PentestProject():
    def __init__(self, settings, overwrite, clean):
        self.settings = settings
        self.name = settings['project_name']
        self.path: Path = BASE_PATH / self.name
        self.root_files = settings['root_files']
        self.clean = clean
        self.overwrite = overwrite
        self.network_list = settings['networks']['names']
        self.standalone_list = settings['standalones']
        self.host_setup = settings['host-setup']

    @staticmethod
    def create_flags_file(hosts: List[Host], path: Path, overwrite: bool):
        create_file(path, overwrite)
        with path.open('a+') as f:
            f.seek(0)
            lines = f.readlines()
            known_hosts = [ line.split()[0] for line in lines ]
            new_hosts = []
            for host in hosts:
                if f"{host.parent_path.name}-{host.hostname}" not in known_hosts and host.hostname not in new_hosts:
                    new_hosts.append(host)
                    f.write(f"{host.parent_path.name+'-'+host.hostname:<35}local.txt \r\n")
                    f.write(f"{host.parent_path.name+'-'+host.hostname:<35}proof.txt \r\n")

    def create_project(self):
        # Create project path
        if self.path.exists() and self.path.is_dir():
            if self.clean:
                shutil.rmtree(self.path)
        self.path.mkdir(parents=True, exist_ok=True)
        standalones_path = self.path / 'standalones'
        standalones_path.mkdir(parents=True, exist_ok=True)
        networks_path = self.path / 'networks'
        networks_path.mkdir(parents=True, exist_ok=True)

        # Create basic files
        for f in self.root_files:
            create_file(self.path / f, self.overwrite)
        create_file(networks_path / self.settings['networks']['creds_file'], self.overwrite)

        # Craft standalones
        standalone_hosts: List[Host] = Host.create_hosts_list(self.standalone_list['hosts'], standalones_path, self.host_setup['files'])
        for host in standalone_hosts:
            host.create_tree(self.overwrite)

        # Craft networks
        nets: List[Network] = []
        for network_name in self.network_list:
            net = Network(
                self.settings['networks'][f'{network_name}']['hosts'],
                networks_path / network_name,
                self.host_setup['files'],
                network_name,
                self.overwrite
            )
            net.create_tree()
            nets.append(net)

        # Craft flags.txt file (or update it)
        full_hosts = []
        full_hosts.extend(standalone_hosts)
        for net in nets:
            full_hosts.extend(net.hosts)
            # Craft hosts.txt (or update it)
            net.create_hosts_file()
        PentestProject.create_flags_file(full_hosts, self.path / self.settings['flags_file'], self.overwrite)

        for host in standalone_hosts:
            logging.info(f"STANDALONE - {host}")
        for net in nets:
            for host in net.hosts:
                logging.info(f"{net} - {host}")


def remove_if_overwrite(file_path: Path, overwrite: bool):
    if file_path.exists() and file_path.is_file():
        logging.debug(f"RM {file_path}")
        file_path.unlink()

def create_file(file_path: Path, overwrite: bool):
    if file_path.exists() and file_path.is_file() and not overwrite:
        return
    remove_if_overwrite(file_path, overwrite)
    logging.debug(f"MKDIR {file_path.parent}")
    file_path.parent.mkdir(parents=True, exist_ok=True)
    logging.debug(f"TOUCH {file_path}")
    file_path.touch(exist_ok=True)


# ========== LOGS ==========
def setup_logging(verbose: bool):
    if verbose:
        logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
    else:
        logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')


# ========== MAIN ==========
def main():
    # Create the parser
    parser: ArgumentParser = argparse.ArgumentParser(prog="PentestSetup", formatter_class=argparse.RawDescriptionHelpFormatter,
        description="Pentest project environment preparation tool. Happy Pentest!\n" \
                    "\nFrom machines creation output you can see this\n" \
                    "NEW => Newly added machine (found from config file)\n" \
                    "OLD => Old machine found in directories\n" \
                    ". => Machine is both on config file and directory",
        usage=f"./{Path(__file__).name} -s settings.toml"
    )

    # Add arguments to the parser
    # parser.add_argument('-n', '--name', type=str, required=True, help="Project name (often company name)")
    parser.add_argument('-s', '--settings', type=str, help="Settings file (toml)")
    # parser.add_argument('-e', '--external', type=str, help="Internet accessible hosts (public). Comma separated list.")
    # parser.add_argument('-i', '--internal', type=str, help="Intranet accessible hosts (private). Comma separated list.")
    parser.add_argument('-o', '--overwrite', action='store_true', help="Overwrite existing host folders.")
    parser.add_argument('-c', '--clean', action='store_true', help="Delete project (overwrite not used).")
    parser.add_argument('-v', '--verbose', action='store_true', help="Increase output verbosity (2 levels).")

    # Parse the arguments
    args: Namespace = parser.parse_args()

    # Setup logging
    setup_logging(args.verbose)

    # Read toml configuration
    # Retrieve standalones/networks/hosts
    with open(args.settings, 'r') as f:
        toml_data = f.read() 
    settings = toml.loads(toml_data)

    # Craft project
    project = PentestProject(settings, args.overwrite, args.clean)
    project.create_project()

if __name__ == '__main__':
    main()
